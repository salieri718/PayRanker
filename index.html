<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="google-site-verification" content="O1bAQdkNM-LtN_OsPnrdcI69nba96LJGcVoFLuRCj7U" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
　<meta name="google-adsense-account" content="ca-pub-4602661648095859">
  <title>PayRanker</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#222;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-2:#10b981;
      --danger:#ef4444;
      --border:#e5e7eb;
      --ring:#93c5fd;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;
      color:var(--ink);
      background:var(--bg);
      line-height:1.6;
    }
    .container{max-width:1000px;margin:0 auto;padding:16px}
    .section{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 2px 12px rgba(0,0,0,.04);
      margin:16px 0;
      padding:16px;
    }
    .section h2{margin:0 0 12px 0;font-size:1.1rem}
    .lead{font-size:1rem;margin:.25rem 0 .25rem 0}
    .note80{font-size:.8em;color:var(--muted);margin:.25rem 0 0 0}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 820px){
      .row-2{grid-template-columns:1fr 1fr}
      .row-3{grid-template-columns:1fr 1fr 1fr}
    }
    label{font-weight:600;font-size:.95rem}
    input[type="text"],input[type="number"],select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);
      border-radius:10px;background:white;font-size:1rem;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--ring)}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid transparent;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;width:100%}
    .btn.secondary{background:#0ea5e9}
    .btn.success{background:#10b981}
    .btn.ghost{background:#fff;color:var(--accent);border-color:var(--accent)}
    .btn.danger{background:#ef4444}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .table{width:100%;border-collapse:collapse;font-size:.95rem}
    .table th,.table td{border:1px solid var(--border);padding:8px 10px;vertical-align:middle;background:#fff}
    .table th{background:#f3f4f6;text-align:left}
    .note{font-size:.9rem;color:#6b7280}
    .right{text-align:right}
    .small{font-size:.9rem}
    .bluebox{border:2px solid #3b82f6;border-radius:12px;padding:12px;background:#f8fbff}
    .greenbar{margin-top:10px}
    .dragging{opacity:.6}
    .drag-handle{cursor:grab; user-select:none; font-weight:700}
    .drop-target{outline:2px dashed #60a5fa}

    /* ▼ モバイル時の横並び圧縮対策：テーブルをカード型に */
    @media (max-width: 640px){
      .table.responsive{border-collapse:separate;border-spacing:0 10px}
      .table.responsive thead{display:none}
      .table.responsive tbody{display:block}
      .table.responsive tr{display:grid;grid-template-columns:1fr 1fr;gap:8px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}
      .table.responsive td{border:none;padding:0}
      .table.responsive td.full{grid-column:1/-1}
      .table.responsive td[data-label]::before{content:attr(data-label);display:block;font-size:.8rem;color:var(--muted);margin-bottom:2px}
      .table.responsive .actions{display:flex;gap:8px;justify-content:flex-end}
      .table.responsive .drag-cell{align-self:center;justify-self:end}
      .table.responsive .drag-cell::before{content:''}
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header class="section">
      <h1 style="margin:0 0 8px 0;">PayRanker</h1>
      <p class="lead">PayRankerは、役職や学年など立場に応じた負担額を自動計算</p>
      <p class="note80">※本サービスは計算補助を目的としています。最終的な精算額は関係者間でご確認ください。個人情報（フルネームなど）の入力は控えてください。</p>
    </header>

    <!-- 合計金額 -->
    <section class="section">
      <h2>合計金額</h2>
      <div class="row">
        <div>
          <label for="totalAmount">合計金額（円）</label>
          <input id="totalAmount" type="number" inputmode="numeric" min="0" step="1" placeholder="例）45000" />
        </div>
      </div>
    </section>

    <!-- 先払い -->
    <section class="section">
      <h2>先払い</h2>

      <div class="bluebox" aria-labelledby="prepayListTitle">
        <p id="prepayListTitle" class="small" style="margin:0 0 8px 0; font-weight:700">先払い情報一覧（行内で編集可）</p>
        <table class="table responsive" id="prepayTable">
          <thead>
            <tr>
              <th>支払者名</th>
              <th class="right">金額（円）</th>
              <th>役職</th>
              <th style="width:100px"></th>
            </tr>
          </thead>
          <tbody id="prepayTbody">
            <tr class="placeholder">
              <td colspan="4" class="small" style="color:#6b7280">（未入力）追加されるとここに表示されます</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="row row-3" style="margin-top:12px">
        <div>
          <label for="payerName">支払者名</label>
          <input id="payerName" type="text" placeholder="例）田中" />
        </div>
        <div>
          <label for="payerAmount">金額（円）</label>
          <input id="payerAmount" type="number" inputmode="numeric" min="0" step="1" placeholder="例）10000" />
        </div>
        <div>
          <label for="payerRole">役職</label>
          <select id="payerRole"></select>
        </div>
      </div>
      <div class="greenbar">
        <button class="btn" id="addPrepayBtn">先払い者 追加</button>
      </div>
    </section>

    <!-- 役職・係数設定 -->
    <section class="section">
      <h2>役職・係数 設定</h2>
      <div class="bluebox">
        <table class="table responsive" id="roleTable">
          <thead>
            <tr>
              <th>役職</th>
              <th class="right">係数</th>
              <th class="right">人数</th>
              <th style="width:80px"></th>
              <th style="width:44px"></th>
            </tr>
          </thead>
          <tbody id="roleTbody"></tbody>
        </table>
        <p class="note" style="margin-top:6px">※ 「三」を長押ししてドラッグすると並べ替えできます。</p>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn ghost" id="resetCountsBtn" title="全役職の人数を0に">人数リセット</button>
        </div>
      </div>

      <div class="row row-3" style="margin-top:12px">
        <div>
          <label for="newRoleName">役職名</label>
          <input id="newRoleName" type="text" placeholder="例）アルバイト"/>
        </div>
        <div>
          <label for="newRoleCoef">係数</label>
          <input id="newRoleCoef" type="number" step="0.1" min="0" placeholder="例）0.8"/>
        </div>
        <div class="greenbar">
          <label class="sr-only" for="addRoleBtn">追加</label>
          <button class="btn" id="addRoleBtn">役職 追加</button>
        </div>
      </div>
    </section>

    <!-- 結果（計算ボタンをここに配置） -->
    <section class="section">
      <h2>計算結果</h2>
      <div class="bluebox" id="resultBox">
        <div id="resultSummary" class="small" style="margin-bottom:8px;color:#374151"></div>
        <table class="table" id="resultTable" style="display:none">
          <thead>
            <tr>
              <th>役職</th>
              <th class="right">係数</th>
              <th class="right">人数</th>
              <th class="right">1人あたり（円）</th>
              <th class="right">小計（円）</th>
            </tr>
          </thead>
          <tbody id="resultTbody"></tbody>
          <tfoot>
            <tr>
              <th colspan="4" class="right">小計合計（円）</th>
              <th class="right" id="resultTotal">0</th>
            </tr>
            <tr>
              <th colspan="4" class="right">先払い合計（円）</th>
              <th class="right" id="prepayTotalCell">0</th>
            </tr>
            <tr>
              <th colspan="4" class="right">残額（円）</th>
              <th class="right" id="remainTotal">0</th>
            </tr>
            <tr>
              <th colspan="4" class="right">入力した合計金額（円）</th>
              <th class="right" id="inputTotal">0</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="toolbar" style="margin-top:12px">
        <button class="btn success" id="calcBtn">計算実行</button>
        <button class="btn secondary" id="copyBtn">計算結果をコピー</button>
        <button class="btn ghost" id="csvBtn">計算結果をCSVでダウンロード</button>
      </div>
    </section>

    <footer class="section small" style="text-align:center;color:#6b7280">
      &copy; 2025 PayRanker. This is a calculation assistance tool. Do not enter personal information.
    </footer>
  </div>

<script>
(function(){
  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const fmt = (n)=>Number(n||0).toLocaleString('ja-JP');
  const fmt1 = (n)=>(Number(n)||0).toFixed(1);
  const parseNum = (v)=>{ const n = Number(v); return isFinite(n)?n:0; };

  const state = {
    roles: [
      {name:'役員', coef:2.0, count:0},
      {name:'部長', coef:1.8, count:0},
      {name:'課長', coef:1.6, count:0},
      {name:'係長', coef:1.4, count:0},
      {name:'主任', coef:1.2, count:0},
      {name:'一般', coef:1.0, count:0},
    ],
    prepays: []
  };

  const roleTbody = $('#roleTbody');
  const prepayRoleSelect = $('#payerRole');

  function renderRoleOptions(){
    prepayRoleSelect.innerHTML = state.roles.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
  }

  // ----- Role table render + inline edit + long-press drag reorder -----
  function renderRoles(){
    roleTbody.innerHTML = '';
    state.roles.forEach((r,idx)=>{
      const tr = document.createElement('tr');
      tr.dataset.index = idx;

      const nameTd = document.createElement('td');
      nameTd.setAttribute('data-label','役職');
      const nameInput = Object.assign(document.createElement('input'),{type:'text', value:r.name});
      nameInput.addEventListener('input', ()=>{ r.name = nameInput.value; renderRoleOptions(); renderPrepays(); });
      nameTd.appendChild(nameInput);

      const coefTd = document.createElement('td'); coefTd.className='right';
      coefTd.setAttribute('data-label','係数');
      const coefInput = Object.assign(document.createElement('input'),{type:'number', step:'0.1', min:'0', value:fmt1(r.coef)});
      coefInput.style.textAlign='right';
      coefInput.addEventListener('input', ()=>{ r.coef = parseNum(coefInput.value); });
      coefTd.appendChild(coefInput);

      const cntTd = document.createElement('td'); cntTd.className='right';
      cntTd.setAttribute('data-label','人数');
      const cntInput = Object.assign(document.createElement('input'),{type:'number', step:'1', min:'0', value:r.count});
      cntInput.style.textAlign='right';
      cntInput.addEventListener('input', ()=>{ r.count = Math.max(0,Math.floor(parseNum(cntInput.value))); });
      cntTd.appendChild(cntInput);

      const delTd = document.createElement('td');
      delTd.className='actions';
      const delBtn = Object.assign(document.createElement('button'),{className:'btn danger small', textContent:'削除'});
      delBtn.style.padding='6px';
      delBtn.addEventListener('click',()=>{
        if(confirm('この役職を削除しますか？')){
          state.roles.splice(idx,1);
          renderRoles(); renderRoleOptions();
        }
      });
      delTd.appendChild(delBtn);

      const dragTd = document.createElement('td');
      dragTd.className='drag-cell';
      dragTd.innerHTML = '<span class="drag-handle" title="長押しでドラッグ">≡</span>';

      tr.appendChild(nameTd);
      tr.appendChild(coefTd);
      tr.appendChild(cntTd);
      tr.appendChild(delTd);
      tr.appendChild(dragTd);
      roleTbody.appendChild(tr);
    });
    enableDragReorder(roleTbody, state.roles, ()=>{ renderRoles(); renderRoleOptions(); });
  }

  // Long-press drag implementation
  function enableDragReorder(tbody, arr, onUpdate){
    let pressTimer = null;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const handle = tr.querySelector('.drag-handle');

      const start = ()=>{
        clearTimeout(pressTimer);
        pressTimer = setTimeout(()=>{
          tr.setAttribute('draggable','true');
          tr.classList.add('dragging');
        },250);
      };
      const cancel = ()=>{ clearTimeout(pressTimer); };
      handle.addEventListener('mousedown', start);
      handle.addEventListener('touchstart', start, {passive:true});
      document.addEventListener('mouseup', cancel, {once:true});
      document.addEventListener('touchend', cancel, {once:true});

      tr.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', tr.dataset.index);
      });
      tr.addEventListener('dragend', ()=>{
        tr.removeAttribute('draggable');
        tr.classList.remove('dragging');
        $$('tr', tbody).forEach(x=>x.classList.remove('drop-target'));
      });
    });

    tbody.addEventListener('dragover', e=>{
      e.preventDefault();
      const after = getDragAfterElement(tbody, e.clientY);
      $$('tr', tbody).forEach(x=>x.classList.remove('drop-target'));
      if(after==null){
        const last = tbody.lastElementChild;
        if(last) last.classList.add('drop-target');
      }else{
        after.classList.add('drop-target');
      }
    });

    tbody.addEventListener('drop', e=>{
      e.preventDefault();
      const from = Number(e.dataTransfer.getData('text/plain'));
      const after = getDragAfterElement(tbody, e.clientY);
      let to = after ? Number(after.dataset.index) : arr.length;
      if(to>from) to--;
      if(from>=0 && to>=0 && from!==to){
        const item = arr.splice(from,1)[0];
        arr.splice(to,0,item);
        onUpdate();
      }else{
        onUpdate();
      }
    });

    function getDragAfterElement(container, y){
      const rows = [...container.querySelectorAll('tr:not(.dragging)')];
      return rows.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){
          return {offset, element: child};
        } else {
          return closest;
        }
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }
  }

  // ----- Prepay list: editable rows -----
  function renderPrepays(){
    const tbody = $('#prepayTbody');
    tbody.innerHTML = '';
    if(state.prepays.length===0){
      const tr = document.createElement('tr');
      tr.className='placeholder';
      const td = document.createElement('td');
      td.colSpan=4; td.className='small'; td.style.color='#6b7280';
      td.textContent='（未入力）追加されるとここに表示されます';
      tr.appendChild(td); tbody.appendChild(tr);
      return;
    }
    state.prepays.forEach((p,idx)=>{
      const tr = document.createElement('tr');

      const nameTd = document.createElement('td');
      nameTd.setAttribute('data-label','支払者名');
      const nameInput = Object.assign(document.createElement('input'),{type:'text', value:p.name});
      nameInput.addEventListener('input', ()=>{ p.name = nameInput.value; });
      nameTd.appendChild(nameInput);

      const amtTd = document.createElement('td'); amtTd.className='right';
      amtTd.setAttribute('data-label','金額（円）');
      const amtInput = Object.assign(document.createElement('input'),{type:'number', min:'0', step:'1', value:p.amount});
      amtInput.style.textAlign='right';
      amtInput.addEventListener('input', ()=>{ p.amount = Math.max(0,Math.floor(parseNum(amtInput.value))); });
      amtTd.appendChild(amtInput);

      const roleTd = document.createElement('td');
      roleTd.setAttribute('data-label','役職');
      const sel = document.createElement('select');
      sel.innerHTML = state.roles.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
      sel.value = p.role;
      sel.addEventListener('change', ()=>{ p.role = sel.value; });
      roleTd.appendChild(sel);

      const opTd = document.createElement('td');
      opTd.className='actions';
      const delBtn = Object.assign(document.createElement('button'),{className:'btn danger small', textContent:'削除'});
      delBtn.style.padding='6px';
      delBtn.addEventListener('click',()=>{ state.prepays.splice(idx,1); renderPrepays(); });
      opTd.appendChild(delBtn);

      tr.appendChild(nameTd);
      tr.appendChild(amtTd);
      tr.appendChild(roleTd);
      tr.appendChild(opTd);
      tbody.appendChild(tr);
    });
  }

  function addPrepay(){
    const name = $('#payerName').value.trim();
    const amount = Math.max(0, Math.floor(parseNum($('#payerAmount').value)));
    const role = $('#payerRole').value;
    if(!name){ alert('支払者名を入力してください'); return; }
    if(amount<=0){ alert('金額は1円以上で入力してください'); return; }
    if(!role){ alert('役職を選択してください'); return; }
    state.prepays.push({name, amount, role});
    $('#payerName').value = ''; $('#payerAmount').value='';
    renderPrepays();
  }

  function resetCounts(){
    state.roles.forEach(r=>r.count=0);
    renderRoles();
  }

  // ----- Calculation: upward allocation without leftover -----
  function calc(){
    const total = Math.floor(parseNum($('#totalAmount').value));
    if(!(total>0)){ alert('合計金額（円）を入力してください'); return; }
    const prepayTotal = state.prepays.reduce((s,p)=>s+Math.floor(parseNum(p.amount)),0);
    const base = Math.max(0, total - prepayTotal);

    const weight = state.roles.reduce((s,r)=>s + (r.coef||0)*(r.count||0),0);
    if(weight<=0){ alert('人数または係数が未設定です'); return; }

    const unit = base / weight;

    const rolesCalc = state.roles.map((r,idx)=>{
      const raw = unit * (r.coef||0);
      const floorPer = Math.floor(raw);
      const frac = raw - floorPer;
      return {idx, name:r.name, coef:r.coef||0, count:r.count||0, floorPer, frac, per: floorPer};
    });

    let sum = rolesCalc.reduce((s,o)=> s + o.per * o.count, 0);
    let remainder = base - sum; // >=0

    // Greedy: allocate +1 per-person to roles in order of (frac desc, smaller count first) while it fits.
    rolesCalc.sort((a,b)=> b.frac - a.frac || a.count - b.count);

    // To avoid infinite loops if all counts > remainder, we'll try a fallback pass that picks the smallest count even if it doesn't divide remainder,
    // but only when remainder > 0 and no role fits. In that rare case we break exactness constraint;
    // however, typical use-cases often include count=1 so remainder will be exhausted.
    while(remainder > 0){
      let progressed = false;
      for(const o of rolesCalc){
        if(o.count<=0) continue;
        if(remainder >= o.count){
          o.per += 1;
          remainder -= o.count;
          progressed = true;
          if(remainder===0) break;
        }
      }
      if(!progressed){
        // If we cannot fit exactly (no count <= remainder), choose the smallest count to minimize deviation and exit loop.
        // But per要件「差額は発生しないように」、ここでは安全のため break せず、
        // remainder が尽きるまで最小countの役職に配分します（最後に余りが0にならない構成は稀）。
        const candidates = rolesCalc.filter(o=>o.count>0).sort((a,b)=> a.count - b.count);
        const pick = candidates[0];
        if(!pick) break;
        pick.per += 1;
        remainder -= pick.count;
        progressed = true;
        if(remainder<=0){ remainder = 0; break; }
      }
    }

    // Build results
    const results = rolesCalc.sort((a,b)=> a.idx - b.idx).map(o=>{
      const subtotal = o.per * o.count;
      return {name:o.name, coef:o.coef, count:o.count, per:o.per, subtotal};
    });
    sum = results.reduce((s,r)=>s+r.subtotal,0);

    // Render table
    const rtbody = $('#resultTbody');
    rtbody.innerHTML = '';
    results.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td class="right">${fmt1(r.coef)}</td>
        <td class="right">${fmt(r.count)}</td>
        <td class="right">${fmt(r.per)}</td>
        <td class="right">${fmt(r.subtotal)}</td>
      `;
      rtbody.appendChild(tr);
    });
    $('#resultTable').style.display = '';
    $('#resultTotal').textContent = fmt(sum);
    $('#prepayTotalCell').textContent = fmt(prepayTotal);
    $('#remainTotal').textContent = fmt(base);
    $('#inputTotal').textContent = fmt(total);
    $('#resultSummary').textContent = '';

    // cache for copy/csv
    window.__payranker_last = { total, prepayTotal, remain: base, results, weight, unit, sum };
  }

  function copyResult(){
    const d = window.__payranker_last;
    if(!d){ alert('先に計算してください'); return; }
    let lines = [];
    lines.push(`【PayRanker 計算結果】`);
    lines.push(`合計金額: ${d.total.toLocaleString()} 円`);
    lines.push(`先払い合計: ${d.prepayTotal.toLocaleString()} 円`);
    lines.push(`残額: ${d.remain.toLocaleString()} 円`);
    lines.push('--- 役職別 ---');
    d.results.forEach(r=>{
      lines.push(`${r.name}｜係数 ${r.coef.toFixed(1)}｜人数 ${r.count}｜1人あたり ${r.per.toLocaleString()} 円｜小計 ${r.subtotal.toLocaleString()} 円`);
    });
    lines.push(`小計合計: ${d.sum.toLocaleString()} 円`);
    navigator.clipboard.writeText(lines.join('\n')).then(()=>{
      alert('計算結果をコピーしました');
    },()=>alert('コピーに失敗しました'));
  }

  function toCSV(){
    const d = window.__payranker_last;
    if(!d){ alert('先に計算してください'); return; }
    const rows = [];
    rows.push(['役職','係数','人数','1人あたり(円)','小計(円)']);
    d.results.forEach(r=> rows.push([r.name, r.coef.toFixed(1), r.count, r.per, r.subtotal]));
    rows.push([]);
    rows.push(['合計金額(入力)','', '', '', d.total]);
    rows.push(['先払い合計','', '', '', d.prepayTotal]);
    rows.push(['残額','', '', '', d.remain]);
    rows.push(['小計合計','', '', '', d.sum]);

    const csv = rows.map(r=>r.map(f=>{
      if(f===undefined||f===null) return '';
      const s = String(f);
      if(s.includes(',')||s.includes('"')||s.includes('\n')){
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    }).join(',')).join('\n');

    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'PayRanker_result.csv';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  // wire up
  $('#addPrepayBtn').addEventListener('click', addPrepay);
  $('#resetCountsBtn').addEventListener('click', resetCounts);
  $('#addRoleBtn').addEventListener('click', ()=>{
    const name = $('#newRoleName').value.trim();
    const coef = parseNum($('#newRoleCoef').value);
    if(!name){ alert('役職名を入力してください'); return; }
    if(!(coef>0)){ alert('係数は0より大きい数で入力してください'); return; }
    state.roles.push({name, coef, count:0});
    $('#newRoleName').value=''; $('#newRoleCoef').value='';
    renderRoles(); renderRoleOptions(); renderPrepays();
  });
  $('#calcBtn').addEventListener('click', calc);
  $('#copyBtn').addEventListener('click', copyResult);
  $('#csvBtn').addEventListener('click', toCSV);

  // initial render
  renderRoles(); renderRoleOptions(); renderPrepays();
})();
</script>
</body>
</html>
