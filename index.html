<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>PayRanker｜役職係数で公平に割り勘</title>
<style>
  :root{
    --gap:16px; --radius:14px; --border:#e5e7eb; --muted:#6b7280; --bg:#fff;
    --accent:#16a34a; --danger:#ef4444; --handle:#94a3b8;
    --control-h:40px;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
  }
  html,body{background:#f7f7f7}
  body{margin:16px}
  /* レイアウト */
  .wrap{max-width:1200px; margin:0 auto; display:grid; gap:var(--gap); grid-template-columns:1.1fr 0.9fr; align-items:start}
  .card{border:1px solid var(--border); border-radius:var(--radius); padding:16px; background:var(--bg)}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  input,select,button{font:inherit; height:var(--control-h); box-sizing:border-box}
  input[type="number"]{text-align:right}
  table{width:100%; border-collapse:collapse}
  th,td{border-bottom:1px solid #f1f5f9; padding:8px; text-align:left; vertical-align:middle}
  th{background:#fafafa; font-weight:600; white-space:nowrap}
  .right{text-align:right} .mono{font-variant-numeric:tabular-nums}
  .btn{padding:0 14px; border:1px solid #d1d5db; border-radius:999px; background:#fff; cursor:pointer; white-space:nowrap; line-height:1}
  .btn.primary{background:var(--accent); color:#fff; border-color:#0d8f3c}
  .btn.warn{background:var(--danger); color:#fff; border-color:#dc2626}
  .muted{color:var(--muted); font-size:12px}
  .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
  /* 列幅（見出しが2行にならないよう調整） */
  #payersTable col.name { width: 160px; }
  #payersTable col.amount { width: 120px; }
  #payersTable col.role { width: 180px; }
  #payersTable col.included { width: 160px; }
  #payersTable col.del { width: 90px; }
  #rolesTable  col.r-name { width:auto; }
  #rolesTable  col.r-coef { width: 100px; }
  #rolesTable  col.r-count{ width: 110px; }
  #rolesTable  col.r-del  { width: 90px; }
  #rolesTable  col.r-sort { width: 64px; }
  /* 並べ替えハンドル（右端） */
  .handle{display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px;
    border-radius:6px; border:1px solid #cbd5e1; background:#f1f5f9; color:var(--handle); cursor:grab}
  .dragging{opacity:.6} .drop-target{outline:2px dashed #94a3b8; outline-offset:-6px}
  /* 入力サイズ（係数=小数1桁 / 人数=最大3桁） */
  .coef-input{ width:6ch; }
  .count-input{ width:5ch; }
  .small-chip{ display:inline-flex; align-items:center; height:24px; padding:0 8px; border-radius:999px; background:#f1f5f9; color:#6b7280; font-size:12px }
  /* 削除ボタンが2行にならないように */
  .btn.delete { white-space:nowrap; }
  /* スマホ最適化 */
  @media (max-width: 900px){
    body{margin:12px}
    .wrap{grid-template-columns:1fr}
    input,select,button{font-size:16px} /* iOS ズーム防止 */
    .btn{min-height:44px; width:100%}
  }
</style>
</head>
<body>
  <!-- ヘッダー（サービス名＋説明） -->
  <section class="card" style="max-width:1200px; margin:0 auto 12px;">
    <h1 style="margin:0 0 6px; font-size:22px;">PayRanker</h1>
    <p style="margin:0 0 6px; color:#374151;">役職に応じた係数で、みんなの支払いをスマートに按分する<strong>計算補助ツール</strong>です。</p>
    <p class="muted" style="margin:0;">
      ※本サイトは計算結果の<strong>参考</strong>を提供します。最終的な金額は参加者間でご確認ください。<br>
      ※<strong>個人情報（氏名・メール・電話等）は入力しないでください</strong>。ニックネームなどを推奨します。
    </p>
  </section>

  <div class="wrap">
    <!-- 左：設定 -->
    <section class="card" id="settingsCard">
      <!-- 合計金額 -->
      <div class="row" style="justify-content:space-between;">
        <div class="row" style="min-width:280px">
          <label class="muted" for="total" style="margin:0;">合計金額</label>
          <input id="total" type="number" min="0" step="1" placeholder="例: 48500" style="width:220px;">
          <span class="muted">円・税込</span>
        </div>
      </div>

      <!-- 先払い -->
      <div style="margin-top:10px">
        <label class="muted">先払い（複数可）</label>
        <div class="table-wrap">
          <table id="payersTable" aria-label="先払いテーブル">
            <colgroup>
              <col class="name"><col class="amount"><col class="role"><col class="included"><col class="del">
            </colgroup>
            <thead>
              <tr>
                <th>名前</th>
                <th class="right">金額（円）</th>
                <th>役職（支払人数に含める場合）</th>
                <th class="right">支払人数に含める</th>
                <th class="right">削除</th>
              </tr>
            </thead>
            <tbody id="payersBody"></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="newPayerName" placeholder="例：Aさん" style="width:160px;">
          <input id="newPayerAmount" type="number" min="0" step="1" placeholder="0" style="width:120px;">
          <span class="muted">円</span>
          <select id="newPayerRole" class="role-options" style="min-width:160px;"></select>
          <label class="row" style="align-items:center"><input id="newPayerIncluded" type="checkbox" style="width:auto;"><span class="muted">支払人数に含める</span></label>
          <button class="btn" id="addPayer" style="width:auto;">先払いを追加</button>
        </div>
      </div>

      <!-- 役職テーブル -->
      <div style="margin-top:16px">
        <label class="muted">役職ごとの係数（人数編集可）</label>
        <div class="table-wrap">
          <table id="rolesTable" aria-label="役職係数テーブル">
            <colgroup>
              <col class="r-name"><col class="r-coef"><col class="r-count"><col class="r-del"><col class="r-sort">
            </colgroup>
            <thead>
              <tr>
                <th>役職名</th>
                <th class="right">係数</th>
                <th class="right">人数</th>
                <th class="right">削除</th>
                <th class="right">並び</th>
              </tr>
            </thead>
            <tbody id="rolesBody"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:8px;">
          <input id="newRoleName" placeholder="例：取締役" style="width:160px;">
          <input id="newRoleCoef" class="coef-input" type="number" step="0.1" min="0" placeholder="2.0" inputmode="decimal">
          <input id="newRoleCount" class="count-input" type="number" step="1" min="0" max="999" placeholder="0" inputmode="numeric">
          <span class="muted">人</span>
          <button class="btn" id="addRole" style="width:auto;">役職を追加</button>
          <button class="btn warn" id="resetCounts" style="width:auto;">人数を全て0に</button>
        </div>
      </div>
    </section>

    <!-- 中央：操作 -->
    <section class="card actions-card" style="grid-column:1 / -1;">
      <div class="row" style="gap:10px">
        <button class="btn primary" id="calcTop">計算する</button>
        <button class="btn" id="copyTop">結果をコピー</button>
        <button class="btn" id="csvTop">CSVダウンロード</button>
      </div>
    </section>

    <!-- 右：結果 -->
    <section class="card" id="resultCard">
      <strong>計算結果</strong>
      <div class="table-wrap" style="margin-top:8px">
        <table id="resultTable">
          <thead><tr><th>役職</th><th class="right">係数</th><th class="right">人数</th><th class="right">1人あたり（円）</th><th class="right">合計（円）</th></tr></thead>
          <tbody id="resultBody"></tbody>
          <tfoot><tr><td colspan="4" class="right">合計</td><td class="right mono" id="sumCell">0</td></tr></tfoot>
        </table>
      </div>
      <div id="payerSummary" class="muted" style="margin-top:8px"></div>
    </section>
  </div>

<script>
/* ====== 初期データ（index_v15ベース） ====== */
const DEFAULT_ROLES = [
  { name: "役員", coef: 2.0, count: 0 },
  { name: "部長", coef: 1.5, count: 0 },
  { name: "課長", coef: 1.3, count: 0 },
  { name: "係長", coef: 1.2, count: 0 },
  { name: "主任", coef: 1.1, count: 0 },
  { name: "一般", coef: 1.0, count: 0 },
];
let roles = DEFAULT_ROLES.map(r => ({...r}));
let payers = []; // {name, amount, role, included}

/* ====== DOM ====== */
const rolesBody = document.getElementById('rolesBody');
const payersBody = document.getElementById('payersBody');
const totalInput = document.getElementById('total');
const resultBody = document.getElementById('resultBody');
const sumCell = document.getElementById('sumCell');
const payerSummary = document.getElementById('payerSummary');

/* ====== 役職セレクト更新 ====== */
function renderRoleOptions(selectEl){
  const options = '<option value="">（未指定）</option>' + roles.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
  if (selectEl){
    const prev = selectEl.value; selectEl.innerHTML = options;
    if ([...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  } else {
    document.querySelectorAll('.role-options').forEach(sel=>{
      const prev = sel.value; sel.innerHTML = options;
      if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    });
  }
}

/* ====== 先払いテーブル ====== */
function renderPayers(){
  payersBody.innerHTML = '';
  payers.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${p.name}" data-name style="width:100%"></td>
      <td class="right"><input type="number" data-amount min="0" step="1" value="${p.amount}" style="width:120px;"></td>
      <td><select class="role-options" data-role></select></td>
      <td class="right" style="text-align:center"><input type="checkbox" data-included style="width:auto" ${p.included?'checked':''}></td>
      <td class="right"><button class="btn delete" data-del>削除</button></td>
    `;
    payersBody.appendChild(tr);
    const roleSel = tr.querySelector('[data-role]'); renderRoleOptions(roleSel); roleSel.value = p.role || '';

    tr.querySelector('[data-name]').addEventListener('change', e => payers[i].name = (e.target.value||'').trim());
    tr.querySelector('[data-amount]').addEventListener('change', e => payers[i].amount = Math.max(0, Math.round(Number(e.target.value)||0)));
    tr.querySelector('[data-role]').addEventListener('change', e => { payers[i].role = e.target.value || ''; renderRolesTable(); });
    tr.querySelector('[data-included]').addEventListener('change', e => { payers[i].included = !!e.target.checked; renderRolesTable(); });
    tr.querySelector('[data-del]').addEventListener('click', () => { payers.splice(i,1); renderPayers(); renderRolesTable(); });
  });
}

/* ====== 役職テーブル（並べ替えハンドルを右端へ） ====== */
let dragState = { active:false, fromIndex:-1, overIndex:-1, pressTimer:null };
function renderRolesTable(){
  rolesBody.innerHTML = '';
  const includedMap = getIncludedCountsByRole();
  roles.forEach((r,i)=>{
    const extra = includedMap.get(r.name) || 0;
    const effective = (Number(r.count)||0) + extra;

    const tr = document.createElement('tr');
    tr.dataset.index = i;
    tr.innerHTML = `
      <td><input value="${r.name}" data-role-name style="width:100%"></td>
      <td class="right"><input type="number" step="0.1" min="0" value="${r.coef.toFixed(1)}" data-role-coef class="coef-input"></td>
      <td class="right">
        <div class="row" style="justify-content:flex-end; gap:6px;">
          <input type="number" step="1" min="0" max="999" value="${effective}" data-role-count class="count-input">
          ${extra>0 ? `<span class="small-chip">+${extra}</span>` : ``}
        </div>
      </td>
      <td class="right"><button class="btn delete" data-del>削除</button></td>
      <td class="right" style="width:56px"><div class="handle" title="長押しでドラッグ">≡</div></td>
    `;
    rolesBody.appendChild(tr);

    tr.querySelector('[data-role-name]').addEventListener('change', e=>{
      roles[i].name = (e.target.value||'').trim() || roles[i].name;
      renderRoleOptions(); renderRolesTable();
    });
    tr.querySelector('[data-role-coef]').addEventListener('change', e=>{
      let v = Number(e.target.value); if (!isFinite(v) || v < 0) v = 0;
      roles[i].coef = Math.round(v*10)/10; // 小数1位
      e.target.value = roles[i].coef.toFixed(1);
    });
    tr.querySelector('[data-role-count]').addEventListener('change', e=>{
      let entered = Math.max(0, Math.floor(Number(e.target.value)||0)); if (entered > 999) entered = 999;
      roles[i].count = Math.max(0, entered - extra); renderRolesTable();
    });
    tr.querySelector('[data-del]').addEventListener('click', ()=>{ roles.splice(i,1); renderRolesTable(); renderRoleOptions(); });

    // 長押し→ドラッグ（右端ハンドル）
    const handle = tr.querySelector('.handle');
    const startDrag = ()=>{
      dragState.active = true; dragState.fromIndex = i; dragState.overIndex = i;
      tr.classList.add('dragging'); document.addEventListener('pointermove', onDragMove); document.addEventListener('pointerup', endDrag, {once:true});
    };
    const onPointerDown = e => { if (dragState.active) return; handle.setPointerCapture(e.pointerId); dragState.pressTimer = setTimeout(startDrag, 200); };
    const cancelPress = ()=> clearTimeout(dragState.pressTimer);
    handle.addEventListener('pointerdown', onPointerDown);
    handle.addEventListener('pointerup', cancelPress);
    handle.addEventListener('pointercancel', cancelPress);
  });
}
function onDragMove(e){
  const rows = Array.from(rolesBody.querySelectorAll('tr'));
  const y = e.clientY; let target = -1;
  for (let idx=0; idx<rows.length; idx++){ const rect = rows[idx].getBoundingClientRect(); if (y>=rect.top && y<=rect.bottom){ target = idx; break; } }
  if (target!==-1 && target!==dragState.overIndex){ rows.forEach(r=>r.classList.remove('drop-target')); rows[target].classList.add('drop-target'); dragState.overIndex=target; }
}
function endDrag(){
  document.removeEventListener('pointermove', onDragMove);
  const rows = Array.from(rolesBody.querySelectorAll('tr')); rows.forEach(r=>{ r.classList.remove('drop-target'); r.classList.remove('dragging'); });
  if (dragState.active){
    const from = dragState.fromIndex, to = dragState.overIndex;
    if (from!==-1 && to!==-1 && from!==to){ const item = roles.splice(from,1)[0]; roles.splice(to,0,item); }
  }
  dragState = { active:false, fromIndex:-1, overIndex:-1, pressTimer:null };
  renderRolesTable(); renderRoleOptions();
}

/* ====== 先払いの「支払人数に含める」集計 ====== */
function getIncludedCountsByRole(){
  const m = new Map();
  payers.forEach(p=>{ if (p.included && p.role) m.set(p.role, (m.get(p.role)||0)+1) });
  return m;
}

/* ====== 計算 ====== */
function compute(){
  const total = Math.round(Number(totalInput.value)||0);
  const paidSum = payers.reduce((s,p)=> s + Math.max(0, Math.round(Number(p.amount)||0)), 0);
  const remaining = Math.max(0, total - paidSum);

  const includedMap = getIncludedCountsByRole();
  const weights = roles.map(r=>{
    const extra = includedMap.get(r.name)||0;
    const eff = (Number(r.count)||0) + extra;
    return {...r, count: eff, weight: eff * r.coef};
  });
  const sumWeight = weights.reduce((s,w)=> s + w.weight, 0);
  resultBody.innerHTML=''; payerSummary.textContent=''; sumCell.textContent='0';
  if (sumWeight<=0){ payerSummary.textContent='※ 人数×係数の合計が0です。人数や係数を入力してください。'; return; }

  const unit = remaining / sumWeight;
  const slots = [];
  weights.forEach(w=>{ for(let i=0;i<w.count;i++){ const raw = unit * w.coef; slots.push({role:w.name, coef:w.coef, raw, pay:Math.floor(raw), frac: raw-Math.floor(raw)}); } });
  let diff = remaining - slots.reduce((s,a)=>s+a.pay,0);
  slots.sort((a,b)=> b.frac - a.frac);
  for(let i=0;i<diff;i++) slots[i%slots.length].pay += 1;

  const byRole = new Map();
  slots.forEach(s=>{ if(!byRole.has(s.role)) byRole.set(s.role,{name:s.role,coef:s.coef,count:0,sum:0,pays:[]}); const o=byRole.get(s.role); o.count+=1; o.sum+=s.pay; o.pays.push(s.pay); });

  let sum=0;
  roles.forEach(r=>{
    const o = byRole.get(r.name) || {name:r.name,coef:r.coef,count:0,sum:0,pays:[]};
    sum += o.sum; const per = o.count>0 ? Math.round(o.sum/o.count) : Math.round(unit*o.coef);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.name}</td><td class="right mono">${Number(o.coef).toFixed(1)}</td><td class="right mono">${o.count}</td><td class="right mono">${per.toLocaleString('ja-JP')}</td><td class="right mono">${o.sum.toLocaleString('ja-JP')}</td>`;
    resultBody.appendChild(tr);
  });
  sumCell.textContent = sum.toLocaleString('ja-JP');

  const byRolePays = {}; byRole.forEach((o,role)=> byRolePays[role] = o.pays.sort((a,b)=>a-b));
  const lines = [];
  payers.forEach(p=>{
    const name=(p.name||'（名称未設定）'); const paid=Math.max(0,Math.round(Number(p.amount)||0)); let shouldPay=0;
    if(p.included && p.role){ const arr = byRolePays[p.role] || []; shouldPay = arr.length ? arr.shift() : Math.round(unit*(roles.find(r=>r.name===p.role)?.coef||1)); }
    const balance = shouldPay - paid;
    lines.push(`${name}: 理論 ${shouldPay.toLocaleString('ja-JP')}円 / 先払い ${paid.toLocaleString('ja-JP')}円 / 差額 ${balance.toLocaleString('ja-JP')}円（正=追加支払い / 負=受け取り）`);
  });
  payerSummary.innerHTML = lines.join('<br/>');
}

/* ====== コピー & CSV ====== */
function copyResult(){
  const rows = [['役職','係数','人数','1人あたり(円)','合計(円)']];
  document.querySelectorAll('#resultBody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    rows.push([tds[0].textContent,tds[1].textContent,tds[2].textContent,tds[3].textContent.replace(/,/g,''),tds[4].textContent.replace(/,/g,'')]);
  });
  const sum = document.getElementById('sumCell').textContent.replace(/,/g,''); rows.push(['合計','','','',sum]);
  const payerText = document.getElementById('payerSummary').innerText || '';
  const text = rows.map(r=>r.join('\t')).join('\n') + (payerText? '\n'+payerText:'');
  navigator.clipboard.writeText(text).then(()=>alert('結果をコピーしました（タブ区切り）。')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('結果をコピーしました。');
  });
}
function downloadCsv(){
  const rows = [['役職','係数','人数','1人あたり(円)','合計(円)']];
  document.querySelectorAll('#resultBody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    rows.push([tds[0].textContent,tds[1].textContent,tds[2].textContent,tds[3].textContent.replace(/,/g,''),tds[4].textContent.replace(/,/g,'')]);
  });
  if(rows.length===1){ alert('先に「計算する」を実行してください。'); return; }
  const sum = document.getElementById('sumCell').textContent.replace(/,/g,''); rows.push(['合計','','','',sum]);
  const csv = rows.map(r=> r.map(v=>{const s=String(v??''); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s;}).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`payranker_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* ====== 入出力イベント ====== */
document.getElementById('addPayer').addEventListener('click', ()=>{
  const name=(document.getElementById('newPayerName').value||'').trim() || '（名称未設定）';
  const amount=Math.max(0, Math.round(Number(document.getElementById('newPayerAmount').value)||0));
  const role=document.getElementById('newPayerRole').value || '';
  const included=!!document.getElementById('newPayerIncluded').checked;
  if(!amount){ alert('先払い金額を入力してください'); return; }
  payers.push({name,amount,role,included});
  document.getElementById('newPayerName').value=''; document.getElementById('newPayerAmount').value=''; document.getElementById('newPayerRole').value=''; document.getElementById('newPayerIncluded').checked=false;
  renderPayers(); renderRolesTable();
});
function addRoleFromInputs(){
  const name=(document.getElementById('newRoleName').value||'').trim();
  let coef=Number(String(document.getElementById('newRoleCoef').value).replace(',','.')); if(!isFinite(coef)||coef<0) coef=0;
  coef = Math.round(coef*10)/10;
  let count=Math.max(0, Math.min(999, Math.floor(Number(document.getElementById('newRoleCount').value)||0)));
  if(!name){ alert('役職名を入力してください'); return; }
  roles.push({name,coef,count}); document.getElementById('newRoleName').value=''; document.getElementById('newRoleCoef').value=''; document.getElementById('newRoleCount').value='';
  renderRolesTable(); renderRoleOptions();
}
document.getElementById('addRole').addEventListener('click', addRoleFromInputs);
['newRoleName','newRoleCoef','newRoleCount'].forEach(id=>{
  document.getElementById(id).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addRoleFromInputs(); }});
});

document.getElementById('resetCounts').addEventListener('click', ()=>{ roles = roles.map(r=>({...r,count:0})); renderRolesTable(); });

document.getElementById('calcTop').addEventListener('click', compute);
document.getElementById('copyTop').addEventListener('click', copyResult);
document.getElementById('csvTop').addEventListener('click', downloadCsv);

/* ====== 初期描画 ====== */
function init(){
  renderRolesTable(); renderRoleOptions(); renderPayers();
}
if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init, {once:true}); }
else { init(); }
</script>
</body>
</html>
