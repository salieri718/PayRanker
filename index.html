<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>PayRanker</title>
<style>
  :root{
    --gap:16px; --radius:14px; --border:#e5e7eb; --muted:#6b7280; --bg:#fff;
    --accent:#16a34a; --danger:#ef4444; --handle:#94a3b8;
    --labelW: 120px;
    --chipW: 42px;
    --miniInputW: 82px;
    --delW: 78px;
    --handleW: 44px;
    --blockW: 960px;  /* 外枠カードの統一幅 */
    --inputW: 480px;  /* 入力ボックスの統一幅 */
    --stackW: 560px;  /* ボタン幅の統一 */
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
  }
  *,*::before,*::after{ box-sizing:border-box }
  html,body{ background:#f7f7f7 } body{ margin:16px }
  h1{ margin:0 auto 4px; font-size:22px; text-align:center; max-width:var(--blockW) }
  .desc{ margin:0 auto 12px; color:#374151; font-size:14px; text-align:center; max-width:var(--blockW) }
  .note{ margin:8px auto 16px; color:#6b7280; font-size:12px; text-align:center; max-width:var(--blockW) }
  .wrap{ display:grid; gap:var(--gap); grid-template-columns:1fr; align-items:start; justify-content:center; max-width:var(--blockW); margin:0 auto }
  .card{ border:1px solid var(--border); border-radius:14px; padding:16px; background:#fff; width:100% }
  .subpanel{ border:1px solid #cbd5e1; border-radius:10px; padding:12px; background:#fff; margin:8px 0 12px; }
  .card .subpanel:last-child{ margin-bottom:0 }
  .panel-gap{ height:4px } /* ≈1mm の余白 */
  .section-title{ margin:0 0 8px; font-size:16px; font-weight:700; text-align:left }
  .section-sub{ margin:0 0 8px; font-size:14px; font-weight:600; color:#374151; text-align:left }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:flex-start }
  .btn-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }
  .btn-stack{ display:flex; flex-direction:column; gap:12px; align-items:center }
  .muted{ color:var(--muted); font-size:12px }
  .btn{ padding:10px 12px; border:1px solid #d1d5db; border-radius:999px; background:#fff; cursor:pointer; min-height:44px }
  .btn.primary{ background:var(--accent); color:#fff; border-color:#0d8f3c }
  .btn.warn{ background:#ef4444; color:#fff; border-color:#dc2626 }
  .btn.stacked{ width:clamp(240px, 80%, var(--stackW)); }
  input,select,button{ font:inherit }
  .table-wrap{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch }
  table{ width:100%; border-collapse:collapse; table-layout:fixed }
  th,td{ border-bottom:1px solid #f1f5f9; padding:8px; text-align:left; vertical-align:middle }
  th{ background:#fafafa; font-weight:600; text-align:left }
  .right{ text-align:right } .mono{ font-variant-numeric:tabular-nums }
  /* ラベル & 入力は左揃え */
  .kv .field{ display:flex; align-items:center; gap:8px; flex:1 1 auto; justify-content:flex-start }
  .kv .f-label{ min-width:var(--labelW); text-align:left; color:#111; font-size:14px }
  .unit{ color:var(--muted); font-size:12px }
  .field input[type="number"], .field input[type="text"], .field select { width:var(--inputW); max-width:100% }
  /* 個別幅の統一（ご要望の入力を同幅に） */
  #newPayerName, #newPayerAmount, #newPayerRole,
  #newRoleName, #newRoleCoef { width: var(--inputW); max-width: 100%; }
  /* 並べ替えハンドル */
  .handle{ display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px;
           border-radius:6px; border:1px solid #cbd5e1; background:#f1f5f9; color:#94a3b8; cursor:grab }
  .dragging{ opacity:.6 } .drop-target{ outline:2px dashed #94a3b8; outline-offset:-6px }
  /* ===== Desktop テーブル列幅（重なり防止） ===== */
  @media (min-width: 701px){
    .chip{ display:none }
    #rolesTable col:nth-child(1){ width:auto; }   /* 役職名 */
    #rolesTable col:nth-child(2){ width:140px; }  /* 係数 */
    #rolesTable col:nth-child(3){ width:140px; }  /* 人数 */
    #rolesTable col:nth-child(4){ width:96px; }   /* 削除 */
    #rolesTable col:nth-child(5){ width:64px; }   /* 並び */
    #rolesTable input.count{ width:100px !important; }
    #rolesTable input.coef{ width:100px !important; }
    #rolesTable .btn.del{ width:84px }
  }
  /* ===== モバイル：役職行カード（ハンドル右端） ===== */
  @media (max-width: 700px){
    #rolesTable thead{ display:none }
    #rolesTable tbody{ display:block }
    #rolesTable tbody tr.role-card{
      display:grid;
      grid-template-columns: 1fr var(--delW) var(--handleW);
      grid-template-areas:
        "name del handle"
        "coef count handle";
      gap:10px 12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:10px;
      background:#fff;
      align-items:center;
    }
    #rolesTable tbody tr.role-card td{ border:0; padding:0; text-align:left }
    #rolesTable tbody tr.role-card td[data-area="name"]{ grid-area:name }
    #rolesTable tbody tr.role-card td[data-area="coef"]{ grid-area:coef }
    #rolesTable tbody tr.role-card td[data-area="count"]{ grid-area:count; text-align:left }
    #rolesTable tbody tr.role-card td[data-area="del"]{ grid-area:del; text-align:right }
    #rolesTable tbody tr.role-card td[data-area="handle"]{ grid-area:handle; text-align:right }
    .mini{ display:inline-flex; align-items:center; gap:8px; white-space:nowrap; min-height:36px }
    .chip{ width:var(--chipW); text-align:center; font-size:12px; color:#374151; background:#f3f4f6; padding:3px 0; border-radius:999px }
    .mini input{ width:var(--miniInputW); text-align:right }
    .extra{ margin-left:6px; font-size:12px; color:var(--muted); display:inline-block; min-width:22px }
    .btn.del{ width:var(--delW); min-height:36px; padding:6px 10px; }
    .handle{ width:var(--handleW); height:var(--handleW) }
  }
  /* ===== モバイル：先払い行カード ===== */
  @media (max-width: 700px){
    #payersTable thead{ display:none }
    #payersTable tbody{ display:block }
    #payersTable tbody tr.payer-card{
      display:grid;
      grid-template-columns: 1fr var(--delW);
      grid-template-areas:
        "name   del"
        "amount del"
        "role   del"
        "incl   del";
      gap:10px 12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:10px;
      background:#fff;
      align-items:center;
    }
    #payersTable tbody tr.payer-card td{ border:0; padding:0; text-align:left }
    #payersTable tbody tr.payer-card td:nth-child(1){ grid-area:name }
    #payersTable tbody tr.payer-card td:nth-child(2){ grid-area:amount }
    #payersTable tbody tr.payer-card td:nth-child(3){ grid-area:role }
    #payersTable tbody tr.payer-card td:nth-child(4){ grid-area:incl }
    #payersTable tbody tr.payer-card td:nth-child(5){ grid-area:del; text-align:right }
    #payersTable input[type="text"], #payersTable input[type="number"], #payersTable select{ width:100% }
    #payersTable input[type="number"]{ text-align:right }
    #payersTable .btn{ width:var(--delW); min-height:36px; padding:6px 10px }
  }
  /* モバイル全般 */
  @media (max-width: 900px){
    body{ margin:12px }
    .wrap{ grid-template-columns:1fr }
    input,select,button{ font-size:16px }
    .btn{ min-height:44px }
  }
</style>
</head>
<body>
  <h1>PayRanker</h1>
  <p class="desc">役職ごとの係数と参加人数から、公平感のある割り勘金額を自動計算します。複数の先払いにも対応し、係数の並べ替えは長押しドラッグで変更できます。</p>
  <p class="note">本サイトは<strong>計算補助ツール</strong>です。最終確認は必ず各自で行ってください。個人情報（フルネーム・連絡先・社外情報など）は入力しないでください。</p>

<div class="wrap">
  <!-- 左：設定 -->
  <section class="card kv" id="settingsCard">
    <div class="section-title">会計金額</div>
    <div class="subpanel">
      <div class="row">
        <div class="field" style="min-width:280px">
          <span class="f-label">合計金額</span>
          <input id="total" type="number" min="0" step="1" placeholder="例: 48500">
          <span class="unit">円・税込</span>
        </div>
      </div>
    </div>
    <div class="panel-gap"></div>

    <div class="section-title">先払い（複数可）</div>
    <div class="subpanel">
      <div class="row">
        <div class="field"><span class="f-label">名前</span><input id="newPayerName" placeholder="例：Aさん"></div>
      </div>
      <div class="row">
        <div class="field"><span class="f-label">金額</span><input id="newPayerAmount" type="number" min="0" step="1" placeholder="0"><span class="unit">円</span></div>
      </div>
      <div class="row">
        <div class="field"><span class="f-label">役職</span><select id="newPayerRole" class="role-options"></select></div>
      </div>
      <div class="row" style="align-items:center">
        <label class="field" style="align-items:center"><input id="newPayerIncluded" type="checkbox"><span class="unit">支払人数に含める</span></label>
      </div>
      <div class="btn-stack" style="margin-top:8px">
        <button class="btn stacked" id="addPayer">先払いを追加</button>
      </div>
    </div>
    <div class="panel-gap"></div>

    <div class="section-sub">追加された先払い者情報</div>
    <div class="subpanel">
      <div class="table-wrap">
        <table id="payersTable" aria-label="先払いテーブル">
          <colgroup>
            <col style="width:auto;">
            <col style="width:160px;">
            <col style="width:160px;">
            <col style="width:180px;">
            <col style="width:96px;">
          </colgroup>
          <thead><tr><th>名前</th><th>金額（円）</th><th>役職</th><th>支払人数に含める</th><th></th></tr></thead>
          <tbody id="payersBody"></tbody>
        </table>
      </div>
    </div>
    <div class="panel-gap"></div>

    <div class="section-title">役職、係数設定</div>
    <div class="subpanel">
      <div class="table-wrap">
        <table id="rolesTable" aria-label="役職係数テーブル">
          <colgroup>
            <col style="width:auto;">
            <col style="width:140px;">
            <col style="width:140px;">
            <col style="width:96px;">
            <col style="width:64px;">
          </colgroup>
          <thead><tr><th>役職名</th><th>係数</th><th>人数</th><th></th><th class="right">並び</th></tr></thead>
          <tbody id="rolesBody"></tbody>
        </table>
      </div>
    </div>
    <div class="panel-gap"></div>

    <div class="section-sub">役職カスタム追加</div>
    <div class="subpanel">
      <div class="row">
        <div class="field"><span class="f-label">役職名</span><input id="newRoleName" placeholder="例：取締役"></div>
      </div>
      <div class="row">
        <div class="field"><span class="f-label">係数</span><input id="newRoleCoef" type="number" step="0.1" min="0" placeholder="2.0"></div>
      </div>
      <div class="btn-stack" style="gap:8px">
        <button class="btn stacked" id="addRole">役職を追加</button>
        <button class="btn warn stacked" id="resetCounts">人数を全て0に</button>
      </div>
    </div>
  </section>

  <!-- 中央：操作 -->
  <section class="card actions-card">
    <div class="section-title">計算</div>
    <div class="subpanel">
      <div class="btn-stack">
        <button class="btn primary stacked" id="calcTop">計算する</button>
        <button class="btn stacked" id="copyTop">結果をコピー</button>
        <button class="btn stacked" id="csvTop">CSVダウンロード</button>
      </div>
    </div>
  </section>

  <!-- 右：結果 -->
  <section class="card" id="resultCard">
    <div class="section-title">計算結果と情報</div>
    <div class="subpanel">
      <strong>計算結果</strong>
      <div class="table-wrap" style="margin-top:8px">
        <table id="resultTable">
          <colgroup>
            <col style="width:auto;">
            <col style="width:110px;">
            <col style="width:110px;">
            <col style="width:150px;">
            <col style="width:150px;">
          </colgroup>
          <thead><tr><th>役職</th><th>係数</th><th>人数</th><th class="right">1人あたり（円）</th><th class="right">合計（円）</th></tr></thead>
          <tbody id="resultBody"></tbody>
          <tfoot><tr><td colspan="4" class="right">合計</td><td class="right mono" id="sumCell">0</td></tr></tfoot>
        </table>
      </div>
      <div id="payerSummary" class="muted" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<script>
/* ====== 初期データ ====== */
const DEFAULT_ROLES = [
  { name: "役員", coef: 2.0, count: 0 },
  { name: "部長", coef: 1.5, count: 0 },
  { name: "課長", coef: 1.3, count: 0 },
  { name: "係長", coef: 1.2, count: 0 },
  { name: "主任", coef: 1.1, count: 0 },
  { name: "一般", coef: 1.0, count: 0 },
];
let roles = DEFAULT_ROLES.map(r => ({...r}));
let payers = []; // {name, amount, role, included}

/* ====== DOM ====== */
const rolesBody = document.getElementById('rolesBody');
const payersBody = document.getElementById('payersBody');
const totalInput = document.getElementById('total');
const resultBody = document.getElementById('resultBody');
const sumCell = document.getElementById('sumCell');
const payerSummary = document.getElementById('payerSummary');

/* ====== ラベル幅（左カード）を自動同期 ====== */
function syncLabelWidths(scopeEl){
  const labels = Array.from(scopeEl.querySelectorAll('.f-label'));
  if (!labels.length) return;
  labels.forEach(l => l.style.minWidth = '0px');
  const max = Math.ceil(Math.max(...labels.map(l => l.getBoundingClientRect().width)));
  labels.forEach(l => l.style.minWidth = '');
  scopeEl.style.setProperty('--labelW', (max + 12) + 'px');
}
const kvScope = document.getElementById('settingsCard');
const obs = new MutationObserver(() => syncLabelWidths(kvScope));
obs.observe(kvScope, {childList:true, subtree:true, characterData:true});
window.addEventListener('resize', () => syncLabelWidths(kvScope));

/* ====== 役職セレクト更新 ====== */
function renderRoleOptions(selectEl){
  const options = '<option value="">（未指定）</option>' + roles.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
  if (selectEl){
    const prev = selectEl.value; selectEl.innerHTML = options;
    if ([...selectEl.options].some(o=>o.value===prev)) selectEl.value = prev;
  } else {
    document.querySelectorAll('.role-options').forEach(sel=>{
      const prev = sel.value; sel.innerHTML = options;
      if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    });
  }
}

/* ====== 先払いテーブル ====== */
function renderPayers(){
  payersBody.innerHTML = '';
  payers.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.className = 'payer-card';
    tr.innerHTML = `
      <td><input value="${p.name}" data-name style="width:100%"></td>
      <td><input type="number" data-amount min="0" step="1" value="${p.amount}" style="width:160px; max-width:100%; text-align:right"></td>
      <td><select class="role-options" data-role></select></td>
      <td><label class="row" style="gap:6px; align-items:center"><input type="checkbox" data-included ${p.included?'checked':''}><span class="muted">支払人数に含める</span></label></td>
      <td class="right"><button class="btn" data-del>削除</button></td>
    `;
    payersBody.appendChild(tr);
    const roleSel = tr.querySelector('[data-role]'); renderRoleOptions(roleSel); roleSel.value = p.role || '';

    tr.querySelector('[data-name]').addEventListener('change', e => payers[i].name = (e.target.value||'').trim());
    tr.querySelector('[data-amount]').addEventListener('change', e => payers[i].amount = Math.max(0, Math.round(Number(e.target.value)||0)));
    tr.querySelector('[data-role]').addEventListener('change', e => { payers[i].role = e.target.value || ''; renderRolesTable(); });
    tr.querySelector('[data-included]').addEventListener('change', e => { payers[i].included = !!e.target.checked; renderRolesTable(); });
    tr.querySelector('[data-del]').addEventListener('click', () => { payers.splice(i,1); renderPayers(); renderRolesTable(); });
  });
}

/* ====== 役職テーブル（長押しドラッグ） ====== */
let dragState = { active:false, fromIndex:-1, overIndex:-1, pressTimer:null };
function renderRolesTable(){
  rolesBody.innerHTML = '';
  const includedMap = getIncludedCountsByRole();
  roles.forEach((r,i)=>{
    const extra = includedMap.get(r.name) || 0;
    const effective = (Number(r.count)||0) + extra;

    const tr = document.createElement('tr');
    tr.className = "role-card";
    tr.dataset.index = i;
    tr.innerHTML = `
      <td data-area="name"><input value="${r.name}" data-role-name style="width:100%"></td>
      <td data-area="coef"><div class="mini"><span class="chip">係数</span><input class="coef" type="number" step="0.1" min="0" value="${r.coef}" data-role-coef></div></td>
      <td data-area="count"><div class="mini"><span class="chip">人数</span><input class="count" type="number" step="1" min="0" value="${effective}" data-role-count> ${extra>0 ? `<span class="extra">+${extra}</span>` : `<span class="extra"></span>`}</div></td>
      <td data-area="del" class="right"><button class="btn del" data-del>削除</button></td>
      <td data-area="handle" class="right"><div class="handle" title="長押しでドラッグ">≡</div></td>
    `;
    rolesBody.appendChild(tr);

    tr.querySelector('[data-role-name]').addEventListener('change', e=>{
      roles[i].name = (e.target.value||'').trim() || roles[i].name;
      renderRoleOptions(); renderRolesTable();
    });
    tr.querySelector('[data-role-coef]').addEventListener('change', e=>{
      const v = Math.max(0, Number(e.target.value)||0); roles[i].coef = v;
    });
    tr.querySelector('[data-role-count]').addEventListener('change', e=>{
      const entered = Math.max(0, Math.floor(Number(e.target.value)||0));
      roles[i].count = Math.max(0, entered - extra); renderRolesTable();
    });
    tr.querySelector('[data-del]').addEventListener('click', ()=>{ roles.splice(i,1); renderRolesTable(); renderRoleOptions(); });

    // 長押し→ドラッグ
    const handle = tr.querySelector('.handle');
    const startDrag = ()=>{
      dragState.active = true; dragState.fromIndex = i; dragState.overIndex = i;
      tr.classList.add('dragging'); document.addEventListener('pointermove', onDragMove); document.addEventListener('pointerup', endDrag, {once:true});
    };
    const onPointerDown = e => { if (dragState.active) return; handle.setPointerCapture(e.pointerId); dragState.pressTimer = setTimeout(startDrag, 200); };
    const cancelPress = ()=> clearTimeout(dragState.pressTimer);
    handle.addEventListener('pointerdown', onPointerDown);
    handle.addEventListener('pointerup', cancelPress);
    handle.addEventListener('pointercancel', cancelPress);
  });
}
function onDragMove(e){
  const rows = Array.from(rolesBody.querySelectorAll('tr'));
  const y = e.clientY; let target = -1;
  for (let idx=0; idx<rows.length; idx++){ const rect = rows[idx].getBoundingClientRect(); if (y>=rect.top && y<=rect.bottom){ target = idx; break; } }
  if (target!==-1 && target!==dragState.overIndex){ rows.forEach(r=>r.classList.remove('drop-target')); rows[target].classList.add('drop-target'); dragState.overIndex=target; }
}
function endDrag(){
  document.removeEventListener('pointermove', onDragMove);
  const rows = Array.from(rolesBody.querySelectorAll('tr')); rows.forEach(r=>{ r.classList.remove('drop-target'); r.classList.remove('dragging'); });
  if (dragState.active){
    const from = dragState.fromIndex, to = dragState.overIndex;
    if (from!==-1 && to!==-1 && from!==to){ const item = roles.splice(from,1)[0]; roles.splice(to,0,item); }
  }
  dragState = { active:false, fromIndex:-1, overIndex:-1, pressTimer:null };
  renderRolesTable(); renderRoleOptions();
}

/* ====== 先払いの「支払人数に含める」集計 ====== */
function getIncludedCountsByRole(){
  const m = new Map();
  payers.forEach(p=>{ if (p.included && p.role) m.set(p.role, (m.get(p.role)||0)+1) });
  return m;
}

/* ====== 計算 ====== */
function compute(){
  const total = Math.round(Number(totalInput.value)||0);
  const paidSum = payers.reduce((s,p)=> s + Math.max(0, Math.round(Number(p.amount)||0)), 0);
  const remaining = Math.max(0, total - paidSum);

  const includedMap = getIncludedCountsByRole();
  const weights = roles.map(r=>{
    const extra = includedMap.get(r.name)||0;
    const eff = (Number(r.count)||0) + extra;
    return {...r, count: eff, weight: eff * r.coef};
  });
  const sumWeight = weights.reduce((s,w)=> s + w.weight, 0);
  resultBody.innerHTML=''; payerSummary.textContent=''; sumCell.textContent='0';
  if (sumWeight<=0){ payerSummary.textContent='※ 人数×係数の合計が0です。人数や係数を入力してください。'; return; }

  const unit = remaining / sumWeight;
  const slots = [];
  weights.forEach(w=>{ for(let i=0;i<w.count;i++){ const raw = unit * w.coef; slots.push({role:w.name, coef:w.coef, raw, pay:Math.floor(raw), frac: raw-Math.floor(raw)}); } });
  let diff = remaining - slots.reduce((s,a)=>s+a.pay,0);
  slots.sort((a,b)=> b.frac - a.frac);
  for(let i=0;i<diff;i++) slots[i%slots.length].pay += 1;

  const byRole = new Map();
  slots.forEach(s=>{ if(!byRole.has(s.role)) byRole.set(s.role,{name:s.role,coef:s.coef,count:0,sum:0,pays:[]}); const o=byRole.get(s.role); o.count+=1; o.sum+=s.pay; o.pays.push(s.pay); });

  let sum=0;
  roles.forEach(r=>{
    const o = byRole.get(r.name) || {name:r.name,coef:r.coef,count:0,sum:0,pays:[]};
    sum += o.sum; const per = o.count>0 ? Math.round(o.sum/o.count) : Math.round(unit*o.coef);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.name}</td><td>${Number(o.coef).toFixed(2)}</td><td>${o.count}</td><td class="right mono">${per.toLocaleString('ja-JP')}</td><td class="right mono">${o.sum.toLocaleString('ja-JP')}</td>`;
    resultBody.appendChild(tr);
  });
  sumCell.textContent = sum.toLocaleString('ja-JP');

  const byRolePays = {}; byRole.forEach((o,role)=> byRolePays[role] = o.pays.sort((a,b)=>a-b));
  const lines = [];
  payers.forEach(p=>{
    const name=(p.name||'（名称未設定）'); const paid=Math.max(0,Math.round(Number(p.amount)||0)); let shouldPay=0;
    if(p.included && p.role){ const arr = byRolePays[p.role] || []; shouldPay = arr.length ? arr.shift() : Math.round(unit*(roles.find(r=>r.name===p.role)?.coef||1)); }
    const balance = shouldPay - paid;
    lines.push(`${name}: 理論 ${shouldPay.toLocaleString('ja-JP')}円 / 先払い ${paid.toLocaleString('ja-JP')}円 / 差額 ${balance.toLocaleString('ja-JP')}円（正=追加支払い / 負=受け取り）`);
  });
  payerSummary.innerHTML = lines.join('<br/>');
}

/* ====== コピー & CSV ====== */
function copyResult(){
  const rows = [['役職','係数','人数','1人あたり(円)','合計(円)']];
  document.querySelectorAll('#resultBody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    rows.push([tds[0].textContent,tds[1].textContent,tds[2].textContent,tds[3].textContent.replace(/,/g,''),tds[4].textContent.replace(/,/g,'')]);
  });
  const sum = document.getElementById('sumCell').textContent.replace(/,/g,''); rows.push(['合計','','','',sum]);
  const payerText = document.getElementById('payerSummary').innerText || '';
  const text = rows.map(r=>r.join('\t')).join('\n') + (payerText? '\\n'+payerText:'');
  navigator.clipboard.writeText(text).then(()=>alert('結果をコピーしました（タブ区切り）。')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('結果をコピーしました。');
  });
}
function downloadCsv(){
  const rows = [['役職','係数','人数','1人あたり(円)','合計(円)']];
  document.querySelectorAll('#resultBody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    rows.push([tds[0].textContent,tds[1].textContent,tds[2].textContent,tds[3].textContent.replace(/,/g,''),tds[4].textContent.replace(/,/g,'')]);
  });
  if(rows.length===1){ alert('先に「計算する」を実行してください。'); return; }
  const sum = document.getElementById('sumCell').textContent.replace(/,/g,''); rows.push(['合計','','','',sum]);
  const csv = rows.map(r=> r.map(v=>{const s=String(v??''); return /[",\\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s;}).join(',')).join('\\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`warikan_roles_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* ====== 入出力イベント ====== */
document.getElementById('addPayer').addEventListener('click', ()=>{
  const name=(document.getElementById('newPayerName').value||'').trim() || '（名称未設定）';
  const amount=Math.max(0, Math.round(Number(document.getElementById('newPayerAmount').value)||0));
  const role=document.getElementById('newPayerRole').value || '';
  const included=!!document.getElementById('newPayerIncluded').checked;
  if(!amount){ alert('先払い金額を入力してください'); return; }
  payers.push({name,amount,role,included});
  document.getElementById('newPayerName').value=''; document.getElementById('newPayerAmount').value=''; document.getElementById('newPayerRole').value=''; document.getElementById('newPayerIncluded').checked=false;
  renderPayers(); renderRolesTable();
});
function addRoleFromInputs(){
  const name=(document.getElementById('newRoleName').value||'').trim();
  let coef=Number(String(document.getElementById('newRoleCoef').value).replace(',','.'));
  if(!isFinite(coef)||coef<=0) coef=1.0;
  const count = 0; // 既定で0
  if(!name){ alert('役職名を入力してください'); return; }
  roles.push({name,coef,count});
  document.getElementById('newRoleName').value=''; document.getElementById('newRoleCoef').value='';
  renderRolesTable(); renderRoleOptions();
}
document.getElementById('addRole').addEventListener('click', addRoleFromInputs);
['newRoleName','newRoleCoef'].forEach(id=>{
  document.getElementById(id).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addRoleFromInputs(); }});
});
document.getElementById('resetCounts').addEventListener('click', ()=>{ roles = roles.map(r=>({...r,count:0})); renderRolesTable(); });

document.getElementById('calcTop').addEventListener('click', compute);
document.getElementById('copyTop').addEventListener('click', copyResult);
document.getElementById('csvTop').addEventListener('click', downloadCsv);

/* ====== 初期描画 ====== */
function init(){
  renderRolesTable(); renderRoleOptions(); renderPayers(); syncLabelWidths(kvScope);
}
if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init, {once:true}); }
else { init(); }
</script>
</body>
</html>
